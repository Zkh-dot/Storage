SELECT [2_ÄÀÒÀ_ÏÎÐÒÔÅËß], [42_ÖÔÒ_ID], calc_id
FROM (
    SELECT 
        [2_ÄÀÒÀ_ÏÎÐÒÔÅËß],
        [42_ÖÔÒ_ID],
        calc_id,
        ROW_NUMBER() OVER (PARTITION BY [42_ÖÔÒ_ID] ORDER BY [2_ÄÀÒÀ_ÏÎÐÒÔÅËß] DESC, calc_id DESC) AS row_num
    FROM [RESERVES].[RZRV].[RESERVE_CALCULATE_TEST]
    WHERE 1=1
        AND Òèï_ïîðòôåëÿ = 'Á'
        AND [15_ÄÀÒÀ_ÎÊÎÍ×ÀÍÈß_ÄÎÃÎÂÎÐÀ] > @reporting_date
) AS RankedDeals
WHERE row_num = 1;
